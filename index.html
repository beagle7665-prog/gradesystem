<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班級成績管理與分析系統</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (xlsx) for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* Custom scrollbar for the table */
        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* Style for empty inputs to make them distinct */
        .empty-grade {
            background-color: #fef9c3; /* Yellow-100 */
        }
        .empty-grade:focus {
            background-color: #ffffff;
        }
        .tab-active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .tab-inactive {
            background-color: white;
            color: #4b5563;
            border-color: #e5e7eb;
        }
        .tab-inactive:hover {
            background-color: #f9fafb;
            color: #1d4ed8;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 生成初始的20個成績項目名稱
        const INITIAL_HEADERS = Array.from({ length: 20 }, (_, i) => `項目${i + 1}`);

        // 預設的一筆範例資料
        const INITIAL_STUDENTS = [
            { id: 1, className: "101", number: "01", name: "張小明", grades: Array(20).fill("") },
            { id: 2, className: "101", number: "02", name: "李大華", grades: Array(20).fill("") },
            { id: 3, className: "102", number: "01", name: "王小美", grades: Array(20).fill("") },
        ];

        // 統計級距定義
        const RANGES = [
            { label: "100分", check: (s) => s === 100 },
            { label: "90-99分", check: (s) => s >= 90 && s < 100 },
            { label: "80-89分", check: (s) => s >= 80 && s < 90 },
            { label: "70-79分", check: (s) => s >= 70 && s < 80 },
            { label: "60-69分", check: (s) => s >= 60 && s < 70 },
            { label: "60分以下", check: (s) => s < 60 },
        ];

        function App() {
            const [students, setStudents] = useState(INITIAL_STUDENTS);
            const [headers, setHeaders] = useState(INITIAL_HEADERS);
            const [activeTab, setActiveTab] = useState('input'); // 'input' or 'stats'
            const [selectedStatItem, setSelectedStatItem] = useState(0); // Index of the header to analyze
            const [editingHeader, setEditingHeader] = useState(null); // Which header is being renamed
            
            // 新增功能：班級分頁
            const [currentClassView, setCurrentClassView] = useState("All"); // 'All' or specific className
            const [customClasses, setCustomClasses] = useState([]); // Store manually added classes even if empty

            // 計算所有存在的班級 (包含有學生的班級和手動新增的空班級)
            const availableClasses = useMemo(() => {
                const existingClasses = [...new Set(students.map(s => s.className || "未分類"))];
                // 合併現有班級與手動新增的班級，並移除重複
                const all = [...new Set([...existingClasses, ...customClasses])];
                // 使用 localeCompare 進行自然排序 (讓 10 在 2 後面)
                return all.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            }, [students, customClasses]);

            // 根據目前分頁篩選顯示的學生
            const displayedStudents = useMemo(() => {
                if (currentClassView === "All") return students;
                return students.filter(s => (s.className || "未分類") === currentClassView);
            }, [students, currentClassView]);

            // 新增學生
            const addStudent = () => {
                const newId = students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1;
                
                // 決定新學生的班級
                let targetClass = "101";
                if (currentClassView !== "All") {
                    targetClass = currentClassView;
                } else if (students.length > 0) {
                    targetClass = students[students.length - 1].className;
                }
                
                setStudents([
                    ...students, 
                    { 
                        id: newId, 
                        className: targetClass, 
                        number: "", 
                        name: "", 
                        grades: Array(20).fill("") 
                    }
                ]);
            };

            // 新增一個班級分頁 (優化版)
            const handleAddClassTab = () => {
                const newClass = prompt("請輸入新班級名稱：");
                if (newClass && newClass.trim() !== "") {
                    const trimmedClass = newClass.trim();
                    
                    // 檢查是否已存在
                    if (availableClasses.includes(trimmedClass)) {
                        alert(`「${trimmedClass}」班級已經存在，已為您切換至該分頁。`);
                        setCurrentClassView(trimmedClass);
                        return;
                    }

                    // 使用 callback 更新確保狀態最新
                    setCustomClasses(prev => [...prev, trimmedClass]);
                    setCurrentClassView(trimmedClass);
                }
            };

            // 刪除目前選取的班級
            const handleDeleteClass = () => {
                if (currentClassView === "All") return;
                
                // 計算該班級學生數
                const studentsToDelete = students.filter(s => (s.className || "未分類") === currentClassView);
                const count = studentsToDelete.length;
                
                const confirmMsg = count > 0 
                    ? `確定要刪除「${currentClassView}班」嗎？\n\n警告：這將會刪除該班級 ${count} 位學生的所有資料，此動作無法復原！`
                    : `確定要刪除「${currentClassView}班」分頁嗎？`; // 只有空班級的情況

                if (window.confirm(confirmMsg)) {
                    // 1. 刪除學生
                    setStudents(prev => prev.filter(s => (s.className || "未分類") !== currentClassView));
                    
                    // 2. 移除自訂班級標籤 (如果是手動新增的空班級)
                    setCustomClasses(prev => prev.filter(c => c !== currentClassView));
                    
                    // 3. 回到全部顯示
                    setCurrentClassView("All");
                }
            };

            // 刪除學生
            const removeStudent = (id) => {
                if(window.confirm("確定要刪除這位學生嗎？")) {
                    setStudents(students.filter(s => s.id !== id));
                }
            };

            // 更新學生基本資料
            const updateStudentInfo = (id, field, value) => {
                setStudents(students.map(s => 
                    s.id === id ? { ...s, [field]: value } : s
                ));
            };

            // 更新成績
            const updateGrade = (id, index, value) => {
                // 限制輸入 0-100 或空值
                let numVal = value === "" ? "" : parseFloat(value);
                if (numVal !== "" && (numVal < 0 || numVal > 100)) return;

                setStudents(students.map(s => {
                    if (s.id === id) {
                        const newGrades = [...s.grades];
                        newGrades[index] = numVal;
                        return { ...s, grades: newGrades };
                    }
                    return s;
                }));
            };

            // 更新標題名稱
            const updateHeader = (index, value) => {
                const newHeaders = [...headers];
                newHeaders[index] = value;
                setHeaders(newHeaders);
            };

            // --- 處理表頭貼上邏輯 ---
            const handleHeaderPaste = (e, startIndex) => {
                e.preventDefault();
                const clipboardData = e.clipboardData.getData('text');
                if (!clipboardData) return;

                // 以 Tab 或換行分割
                const values = clipboardData.split(/\t|\n/).map(v => v.trim()).filter(v => v !== "");
                
                const newHeaders = [...headers];
                values.forEach((val, i) => {
                    if (startIndex + i < newHeaders.length) {
                        newHeaders[startIndex + i] = val;
                    }
                });
                setHeaders(newHeaders);
                setEditingHeader(null); // 結束編輯模式
            };

            // --- 處理 Excel 資料貼上邏輯 ---
            const handlePaste = (e, targetStudentId, startColType, startColIndex) => {
                e.preventDefault();
                const clipboardData = e.clipboardData.getData('text');
                if (!clipboardData) return;

                const rows = clipboardData.split(/\r\n|\n|\r/).filter(row => row.trim() !== '');
                if (rows.length === 0) return;

                // 找到起始學生在整個 students 陣列中的 index
                const startStudentIndex = students.findIndex(s => s.id === targetStudentId);
                if (startStudentIndex === -1 && rows.length > 0) return;

                let newStudents = [...students];
                let maxId = newStudents.length > 0 ? Math.max(...newStudents.map(s => s.id)) : 0;

                rows.forEach((rowStr, rOffset) => {
                    const cells = rowStr.split('\t');
                    
                    // 計算目標行
                    let currentTargetIndex = startStudentIndex + rOffset;
                    
                    // 如果超過現有範圍，新增學生
                    if (currentTargetIndex >= newStudents.length) {
                        maxId++;
                        // 預設班級為目前視圖的班級 (若有)
                        const defaultClass = currentClassView !== "All" ? currentClassView : "";
                        newStudents.push({
                            id: maxId,
                            className: defaultClass,
                            number: "",
                            name: "",
                            grades: Array(20).fill("")
                        });
                    }

                    const student = newStudents[currentTargetIndex];
                    
                    cells.forEach((cellData, cOffset) => {
                        let currentVal = cellData.trim();
                        
                        // 計算欄位位置 (0:Class, 1:Num, 2:Name, 3+:Grades)
                        let absoluteStartCol = (startColType === 'meta') ? startColIndex : (3 + startColIndex);
                        const currentAbsoluteCol = absoluteStartCol + cOffset;

                        if (currentAbsoluteCol === 0) student.className = currentVal;
                        else if (currentAbsoluteCol === 1) student.number = currentVal;
                        else if (currentAbsoluteCol === 2) student.name = currentVal;
                        else if (currentAbsoluteCol >= 3 && currentAbsoluteCol < 23) {
                            const gradeIdx = currentAbsoluteCol - 3;
                            let numVal = currentVal === "" ? "" : parseFloat(currentVal);
                            if (numVal !== "" && !isNaN(numVal)) {
                                if (numVal < 0) numVal = 0;
                                if (numVal > 100) numVal = 100;
                                student.grades[gradeIdx] = numVal;
                            } else {
                                student.grades[gradeIdx] = "";
                            }
                        }
                    });
                });

                setStudents(newStudents);
            };


            // 匯出 Excel
            const exportExcel = () => {
                if (students.length === 0) {
                    alert("沒有資料可以匯出");
                    return;
                }

                const wb = XLSX.utils.book_new();
                const classes = [...new Set(students.map(s => s.className || "未分類"))].sort();

                classes.forEach(cls => {
                    const classStudents = students.filter(s => (s.className || "未分類") === cls);
                    const wsData = classStudents.map(s => {
                        let row = {
                            "班級": s.className,
                            "座號": s.number,
                            "姓名": s.name
                        };
                        headers.forEach((h, idx) => {
                            row[h] = s.grades[idx];
                        });
                        return row;
                    });

                    const ws = XLSX.utils.json_to_sheet(wsData);
                    const wscols = [
                        {wch: 10}, {wch: 8}, {wch: 15},
                    ];
                    headers.forEach(() => wscols.push({wch: 10}));
                    ws['!cols'] = wscols;

                    const sheetName = cls.replace(/[\\/?*\[\]]/g, "_").substring(0, 31);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                XLSX.writeFile(wb, `成績總表_${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            // --- 統計邏輯 ---
            const statsData = useMemo(() => {
                const currentHeaderName = headers[selectedStatItem];
                
                // 統計分析時，是否只統計目前分頁？ 通常統計是看該分頁 (班級) 的狀況
                // 如果是 All，則統計所有
                const targetStudents = displayedStudents;

                const validGrades = targetStudents
                    .map(s => s.grades[selectedStatItem])
                    .filter(g => g !== "" && g !== null && g !== undefined);
                
                const total = validGrades.length;
                const avg = total > 0 ? (validGrades.reduce((a, b) => a + b, 0) / total).toFixed(1) : 0;

                const distribution = RANGES.map(range => {
                    const count = validGrades.filter(g => range.check(g)).length;
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                    return { ...range, count, percentage };
                });

                return { total, avg, distribution, currentHeaderName, isFiltered: currentClassView !== "All" };
            }, [displayedStudents, selectedStatItem, headers, currentClassView]);

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-[1920px] mx-auto">
                    
                    {/* Header Section */}
                    <div className="bg-white rounded-lg shadow-sm p-6 mb-6 border border-gray-200">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">
                                    <i className="fa-solid fa-graduation-cap text-blue-600 mr-2"></i>
                                    班級成績管理系統
                                </h1>
                                <p className="text-gray-500 text-sm mt-1">
                                    支援 Excel 貼上 (表頭與內容)、缺交黃底提示、多班級分頁管理
                                </p>
                            </div>
                            <div className="flex gap-3">
                                <button 
                                    onClick={() => setActiveTab('input')}
                                    className={`px-4 py-2 rounded-md font-medium transition-colors ${activeTab === 'input' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                >
                                    <i className="fa-solid fa-table mr-2"></i>成績輸入
                                </button>
                                <button 
                                    onClick={() => setActiveTab('stats')}
                                    className={`px-4 py-2 rounded-md font-medium transition-colors ${activeTab === 'stats' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                >
                                    <i className="fa-solid fa-chart-pie mr-2"></i>統計分析
                                </button>
                                <button 
                                    onClick={exportExcel}
                                    className="px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 transition-colors shadow-sm"
                                >
                                    <i className="fa-solid fa-file-excel mr-2"></i>匯出 Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="bg-white rounded-lg shadow border border-gray-200 overflow-hidden min-h-[600px] flex flex-col">
                        
                        {/* Tab: Data Entry */}
                        {activeTab === 'input' && (
                            <div className="flex flex-col h-full">
                                
                                {/* 班級分頁列 */}
                                <div className="px-4 pt-4 border-b bg-gray-50 overflow-x-auto">
                                    <div className="flex gap-2 pb-0">
                                        <button
                                            onClick={() => setCurrentClassView("All")}
                                            className={`px-4 py-2 rounded-t-lg font-medium text-sm border-t border-l border-r transition-all ${currentClassView === "All" ? 'tab-active' : 'tab-inactive border-b-transparent'}`}
                                        >
                                            全部學生
                                        </button>
                                        {availableClasses.map(cls => (
                                            <button
                                                key={cls}
                                                onClick={() => setCurrentClassView(cls)}
                                                className={`px-4 py-2 rounded-t-lg font-medium text-sm border-t border-l border-r transition-all ${currentClassView === cls ? 'tab-active' : 'tab-inactive border-b-transparent'}`}
                                            >
                                                {cls}班
                                            </button>
                                        ))}
                                        <button 
                                            onClick={handleAddClassTab}
                                            className="px-3 py-2 text-gray-500 hover:text-blue-600 font-medium text-sm flex items-center bg-gray-50 hover:bg-gray-100 border border-transparent hover:border-gray-200 rounded-lg transition-all"
                                            title="新增班級分頁"
                                        >
                                            <i className="fa-solid fa-plus-circle text-lg mr-1"></i> 新增班級
                                        </button>
                                    </div>
                                </div>

                                <div className="p-4 border-b bg-white flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <h2 className="font-semibold text-gray-700">
                                            {currentClassView === "All" ? "所有學生名單" : `${currentClassView}班 - 成績錄入`} 
                                            <span className="ml-2 text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                                                共 {displayedStudents.length} 人
                                            </span>
                                        </h2>
                                    </div>
                                    <div className="flex gap-2">
                                        
                                        {/* 刪除班級按鈕 (僅在非 All 視圖顯示) */}
                                        {currentClassView !== "All" && (
                                            <button 
                                                onClick={handleDeleteClass} 
                                                className="text-sm bg-red-50 text-red-600 px-3 py-1 rounded hover:bg-red-100 border border-red-200 font-medium shadow-sm transition-colors flex items-center mr-2"
                                                title="刪除目前選取的班級"
                                            >
                                                <i className="fa-solid fa-trash-can mr-1"></i>
                                                刪除班級
                                            </button>
                                        )}

                                        <div className="text-xs text-gray-500 flex items-center gap-2 mr-4 bg-yellow-50 px-2 py-1 rounded border border-yellow-200 hidden md:flex">
                                            <i className="fa-regular fa-lightbulb text-yellow-600"></i>
                                            提示：項目名稱與內容均支援 Ctrl+V 貼上
                                        </div>
                                        <button onClick={addStudent} className="text-sm bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 border border-blue-200 font-medium shadow-sm">
                                            <i className="fa-solid fa-plus mr-1"></i>
                                            {currentClassView === "All" ? "新增學生" : `新增 ${currentClassView}班 學生`}
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="flex-1 table-container overflow-auto relative">
                                    <table className="w-full text-sm text-left border-collapse">
                                        <thead className="bg-gray-100 text-gray-700 font-bold sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                <th className="p-3 border-b border-r min-w-[60px] text-center sticky left-0 bg-gray-100 z-20">操作</th>
                                                <th className="p-3 border-b border-r min-w-[80px] sticky left-[60px] bg-gray-100 z-20">班級</th>
                                                <th className="p-3 border-b border-r min-w-[60px] sticky left-[140px] bg-gray-100 z-20">號碼</th>
                                                <th className="p-3 border-b border-r min-w-[120px] sticky left-[200px] bg-gray-100 z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">姓名</th>
                                                
                                                {headers.map((h, idx) => (
                                                    <th key={idx} className="p-2 border-b border-r min-w-[90px] text-center group relative">
                                                        {editingHeader === idx ? (
                                                            <input 
                                                                autoFocus
                                                                type="text" 
                                                                className="w-full text-center border-blue-500 border rounded outline-none p-1"
                                                                value={h}
                                                                onChange={(e) => updateHeader(idx, e.target.value)}
                                                                onPaste={(e) => handleHeaderPaste(e, idx)}
                                                                onBlur={() => setEditingHeader(null)}
                                                                onKeyDown={(e) => e.key === 'Enter' && setEditingHeader(null)}
                                                            />
                                                        ) : (
                                                            <div className="flex items-center justify-center gap-1 cursor-pointer hover:text-blue-600" onClick={() => setEditingHeader(idx)}>
                                                                <span>{h}</span>
                                                                <i className="fa-solid fa-pen text-[10px] opacity-0 group-hover:opacity-50"></i>
                                                            </div>
                                                        )}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {displayedStudents.map((student, sIdx) => (
                                                <tr key={student.id} className="hover:bg-blue-50 transition-colors border-b">
                                                    <td className="p-2 border-r text-center sticky left-0 bg-white z-10">
                                                        <button 
                                                            onClick={() => removeStudent(student.id)}
                                                            className="text-red-400 hover:text-red-600 w-6 h-6 rounded-full hover:bg-red-50"
                                                        >
                                                            <i className="fa-solid fa-trash-can"></i>
                                                        </button>
                                                    </td>
                                                    <td className="p-1 border-r sticky left-[60px] bg-white z-10">
                                                        <input 
                                                            type="text" 
                                                            className="w-full p-2 outline-none bg-transparent focus:bg-white focus:ring-2 focus:ring-blue-100 rounded text-center"
                                                            value={student.className}
                                                            onChange={(e) => updateStudentInfo(student.id, 'className', e.target.value)}
                                                            onPaste={(e) => handlePaste(e, student.id, 'meta', 0)}
                                                            placeholder="班級"
                                                        />
                                                    </td>
                                                    <td className="p-1 border-r sticky left-[140px] bg-white z-10">
                                                        <input 
                                                            type="text" 
                                                            className="w-full p-2 outline-none bg-transparent focus:bg-white focus:ring-2 focus:ring-blue-100 rounded text-center"
                                                            value={student.number}
                                                            onChange={(e) => updateStudentInfo(student.id, 'number', e.target.value)}
                                                            onPaste={(e) => handlePaste(e, student.id, 'meta', 1)}
                                                            placeholder="號"
                                                        />
                                                    </td>
                                                    <td className="p-1 border-r sticky left-[200px] bg-white z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                        <input 
                                                            type="text" 
                                                            className="w-full p-2 outline-none bg-transparent focus:bg-white focus:ring-2 focus:ring-blue-100 rounded"
                                                            value={student.name}
                                                            onChange={(e) => updateStudentInfo(student.id, 'name', e.target.value)}
                                                            onPaste={(e) => handlePaste(e, student.id, 'meta', 2)}
                                                            placeholder="姓名"
                                                        />
                                                    </td>
                                                    {student.grades.map((g, idx) => (
                                                        <td key={idx} className="p-1 border-r text-center">
                                                            <input 
                                                                type="number" 
                                                                className={`w-full p-2 text-center outline-none rounded focus:ring-2 focus:ring-blue-200 transition-colors
                                                                    ${(g === "" || g === null) ? 'empty-grade' : ''}
                                                                    ${g !== "" && g < 60 ? 'text-red-600 font-bold' : ''}
                                                                    ${g === 100 ? 'text-green-600 font-bold' : ''}
                                                                `}
                                                                value={g}
                                                                onChange={(e) => updateGrade(student.id, idx, e.target.value)}
                                                                onPaste={(e) => handlePaste(e, student.id, 'grade', idx)}
                                                                placeholder=""
                                                            />
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                            {displayedStudents.length === 0 && (
                                                <tr>
                                                    <td colSpan={24} className="p-12 text-center text-gray-400">
                                                        <div className="flex flex-col items-center gap-2">
                                                            <i className="fa-regular fa-folder-open text-4xl mb-2"></i>
                                                            <p>此班級尚無學生資料</p>
                                                            <button onClick={addStudent} className="text-blue-600 hover:underline">
                                                                立即新增一位學生
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="p-2 bg-gray-50 text-xs text-gray-500 border-t flex justify-between">
                                    <div className="flex gap-4">
                                        <span className="flex items-center gap-1"><div className="w-3 h-3 bg-yellow-100 border border-gray-300"></div> 缺交/空白</span>
                                        <span className="flex items-center gap-1 text-red-600 font-bold">60分以下</span>
                                    </div>
                                    <span>共 {students.length} 筆資料 (本頁 {displayedStudents.length} 筆)</span>
                                </div>
                            </div>
                        )}

                        {/* Tab: Statistics */}
                        {activeTab === 'stats' && (
                            <div className="p-6 md:p-8 flex flex-col items-center">
                                <div className="w-full max-w-4xl">
                                    
                                    {/* Control Bar - New! */}
                                    <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
                                        
                                        <div className="flex items-center gap-2 w-full md:w-auto">
                                            <label className="font-bold text-gray-700 whitespace-nowrap"><i className="fa-solid fa-users-viewfinder text-purple-600 mr-2"></i>分析對象：</label>
                                            <select 
                                                className="border border-gray-300 rounded-md p-2 w-full md:w-[220px] shadow-sm focus:ring-2 focus:ring-purple-200 outline-none bg-gray-50"
                                                value={currentClassView}
                                                onChange={(e) => setCurrentClassView(e.target.value)}
                                            >
                                                <option value="All">全部年級 / 所有班級</option>
                                                {availableClasses.map(cls => (
                                                    <option key={cls} value={cls}>{cls}班</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div className="flex items-center gap-2 w-full md:w-auto">
                                            <label className="font-bold text-gray-700 whitespace-nowrap"><i className="fa-solid fa-list-check text-blue-600 mr-2"></i>成績項目：</label>
                                            <select 
                                                className="border border-gray-300 rounded-md p-2 w-full md:w-[220px] shadow-sm focus:ring-2 focus:ring-blue-200 outline-none bg-gray-50"
                                                value={selectedStatItem}
                                                onChange={(e) => setSelectedStatItem(parseInt(e.target.value))}
                                            >
                                                {headers.map((h, idx) => (
                                                    <option key={idx} value={idx}>{h}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid md:grid-cols-2 gap-8">
                                        {/* Stats Summary Card */}
                                        <div className="bg-white p-6 rounded-xl shadow-lg border border-purple-100">
                                            <h3 className="text-xl font-bold text-gray-800 mb-4 pb-2 border-b flex justify-between items-center">
                                                <span>{statsData.currentHeaderName} - 概況</span>
                                                {currentClassView !== "All" && (
                                                    <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">{currentClassView}班</span>
                                                )}
                                                {currentClassView === "All" && (
                                                    <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">全校統計</span>
                                                )}
                                            </h3>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-purple-50 p-4 rounded-lg text-center">
                                                    <div className="text-sm text-gray-500">有效成績人數</div>
                                                    <div className="text-3xl font-bold text-purple-700">{statsData.total}</div>
                                                </div>
                                                <div className="bg-blue-50 p-4 rounded-lg text-center">
                                                    <div className="text-sm text-gray-500">平均分數</div>
                                                    <div className="text-3xl font-bold text-blue-700">{statsData.avg}</div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Distribution Table */}
                                        <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                                            <table className="w-full text-sm">
                                                <thead className="bg-gray-800 text-white">
                                                    <tr>
                                                        <th className="p-3 text-left">成績級距</th>
                                                        <th className="p-3 text-right">人數</th>
                                                        <th className="p-3 text-right">佔比</th>
                                                        <th className="p-3">圖示</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {statsData.distribution.map((d, i) => (
                                                        <tr key={i} className="border-b hover:bg-gray-50">
                                                            <td className="p-3 font-medium text-gray-700">{d.label}</td>
                                                            <td className="p-3 text-right font-mono text-base">{d.count}</td>
                                                            <td className="p-3 text-right text-gray-500">{d.percentage}%</td>
                                                            <td className="p-3 w-1/3">
                                                                <div className="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                                                    <div 
                                                                        className={`h-2.5 rounded-full ${i === statsData.distribution.length - 1 ? 'bg-red-500' : 'bg-green-500'}`} 
                                                                        style={{ width: `${d.percentage}%` }}
                                                                    ></div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-8 p-4 bg-yellow-50 text-yellow-800 rounded-lg border border-yellow-200 text-sm">
                                        <i className="fa-solid fa-circle-info mr-2"></i>
                                        此統計基於目前所選的分析對象 ({currentClassView === 'All' ? '全部年級' : currentClassView + '班'})。若欄位空白，將不計入平均與人數統計。
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>